#!/usr/bin/env bash
# agentguard-health: Quick health check for agentguard-protected VPS
# Shows status of swap, memory, OOM protection, tmux, and tsc-guard

set -euo pipefail

# Colors
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    GREEN='' RED='' YELLOW='' BLUE='' BOLD='' NC=''
fi

ok()   { echo -e "  ${GREEN}OK${NC}  $*"; }
warn() { echo -e "  ${YELLOW}WARN${NC} $*"; }
fail() { echo -e "  ${RED}FAIL${NC} $*"; }
header() { echo -e "\n${BOLD}${BLUE}=== $* ===${NC}"; }

echo -e "${BOLD}agentguard health check${NC}"
echo "$(date '+%Y-%m-%d %H:%M:%S') on $(hostname)"

# --- Memory ---
header "Memory"
total_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
avail_kb=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
total_gb=$((total_kb / 1024 / 1024))
avail_gb=$((avail_kb / 1024))
avail_pct=$((avail_kb * 100 / total_kb))

if [ "$avail_pct" -gt 20 ]; then
    ok "RAM: ${avail_gb}MB available / ${total_gb}GB total (${avail_pct}% free)"
elif [ "$avail_pct" -gt 10 ]; then
    warn "RAM: ${avail_gb}MB available / ${total_gb}GB total (${avail_pct}% free)"
else
    fail "RAM: ${avail_gb}MB available / ${total_gb}GB total (${avail_pct}% free) - LOW"
fi

# --- Swap ---
header "Swap"
swap_total=$(grep SwapTotal /proc/meminfo | awk '{print $2}')
swap_free=$(grep SwapFree /proc/meminfo | awk '{print $2}')

if [ "$swap_total" -gt 0 ]; then
    swap_total_mb=$((swap_total / 1024))
    swap_used_mb=$(( (swap_total - swap_free) / 1024 ))
    ok "Swap: ${swap_used_mb}MB used / ${swap_total_mb}MB total"
    if grep -q '/swapfile' /etc/fstab 2>/dev/null; then
        ok "Swap in fstab (persistent)"
    else
        warn "Swap NOT in fstab (will be lost on reboot)"
    fi
else
    fail "No swap configured!"
fi

# --- Swappiness ---
header "Sysctl"
swappiness=$(cat /proc/sys/vm/swappiness)
ok "vm.swappiness = $swappiness"

# OOM protection
for service in sshd dbus systemd-journald; do
    override="/etc/systemd/system/${service}.service.d/agentguard-oom.conf"
    if [ -f "$override" ]; then
        ok "OOM protection: $service"
    else
        warn "OOM protection: $service (not configured)"
    fi
done

# --- tmux ---
header "Tmux"
if command -v tmux &>/dev/null; then
    ok "tmux installed: $(tmux -V 2>/dev/null || echo 'yes')"
else
    fail "tmux not installed"
fi

# Check for TPM
tpm_dir="$HOME/.tmux/plugins/tpm"
if [ -d "$tpm_dir" ]; then
    ok "TPM installed"
else
    warn "TPM not installed"
fi

# Check for resurrect plugin
if [ -d "$HOME/.tmux/plugins/tmux-resurrect" ]; then
    ok "tmux-resurrect installed"
else
    warn "tmux-resurrect not installed"
fi

# Check for continuum
if [ -d "$HOME/.tmux/plugins/tmux-continuum" ]; then
    ok "tmux-continuum installed"
else
    warn "tmux-continuum not installed"
fi

# Check for saved sessions
resurrect_dir="$HOME/.local/share/tmux/resurrect"
if [ -d "$resurrect_dir" ] && ls "$resurrect_dir"/*.txt &>/dev/null 2>&1; then
    latest=$(ls -t "$resurrect_dir"/*.txt 2>/dev/null | head -1)
    if [ -n "$latest" ]; then
        ok "Saved sessions found (latest: $(basename "$latest"))"
    fi
else
    warn "No saved tmux sessions found"
fi

# --- tsc-guard ---
header "tsc-guard"
if command -v tsc-guard &>/dev/null; then
    ok "tsc-guard installed: $(which tsc-guard)"
else
    fail "tsc-guard not installed"
fi

if command -v tsc-guard-install &>/dev/null; then
    ok "tsc-guard-install installed: $(which tsc-guard-install)"
else
    warn "tsc-guard-install not installed"
fi

# Check semaphore state
lock_dir="/tmp/tsc-semaphore"
max_slots="${TSC_GUARD_MAX_SLOTS:-3}"
if [ -d "$lock_dir" ]; then
    locked=0
    for slot in $(seq 1 "$max_slots"); do
        lock_file="$lock_dir/slot-$slot.lock"
        if [ -f "$lock_file" ] && ! flock -n "$lock_file" true 2>/dev/null; then
            locked=$((locked + 1))
        fi
    done
    ok "Semaphore: $locked/$max_slots slots in use"
else
    ok "Semaphore: idle (no lock dir)"
fi

# Count active tsc processes
tsc_count=$(pgrep -c -f 'tsc-real|tsc.*--build' 2>/dev/null || true)
tsc_count="${tsc_count:-0}"
tsc_count="${tsc_count// /}"
if [ "$tsc_count" -gt 0 ] 2>/dev/null; then
    ok "Active tsc processes: $tsc_count"
else
    ok "No active tsc processes"
fi

echo ""
